title: 预发布机器和集群机器共用memcache导致的一次问题
id: 101
categories:
  - mysql
date: 2014-12-01 18:32:24
tags:
---

今天遇到一个奇葩的问题： 做了一个需求之后上线到预发布机器测试， 清空memcache后测试部分页面都是更新的，但是过半个小时之后再看，很多页面都是没有更新过的。

原有逻辑：

crontab-&gt;db.table1-&gt;memcache.key1-&gt;page;

现有逻辑：

后台-&gt;db.table2-&gt;memcache.key2-&gt;page;

花了好几个小时才得以解决： 原因是预发布机器和集群的memcache用的一个，而我对于这个运维机的大架构不熟悉，导致了现在的问题。

清空memcache后，测试的部分页面是OK的原因是，取得数据库的数据；

而半个小时后再看页面未更新的原由是：这些页面由用户触发，而用户触发的是集群里面的原有代码，而原有代码将table1的数据放在了memcache里面，所以，我这边测试的页面都是cache里面的。

解决方案： 将所有的外层数据的memcache的key值也改掉，避免和原有的memcache的数据有任何冲突。

这种问题真是不好解决，如果不能跳出思维圈了解大架构只是在代码层面去深入的话，方向有误就会浪费很多时间。

根治这种问题有两种方案：①测试机和线上的该分离的服务就应该分离 ， ②对于新入职同事或者新接手业务的人，要告知他们运维架构等系列交接培训问题。